<template>
  <div>
    <el-col :span="24" class="editor-wrap">
      <div class="editor-header">
        <div class="article-title">
          <el-input v-model.trim="formItem.title" placeholder="文章标题"></el-input>
        </div>
        <div class="date">
          <el-date-picker
            v-model="formItem.createTime"
            type="datetime"
            placeholder="选择日期时间">
          </el-date-picker>
        </div>
        <div class="abstract">
          <el-input v-model="formItem.abstract" placeholder="摘要"></el-input>
        </div>
        <div class="article-category">
          <el-select
            v-model.trim="formItem.category"
            filterable
            allow-create
            placeholder="请选择文章类别">
            <el-option
              v-for="(item,index) in categoryOptions"
              :key="index"
              :label="item._id"
              :value="item._id">
            </el-option>
          </el-select>
        </div>
        <el-button type="success"
                   class="commit"
                   @click="submit"
                   :loading="submitLoading">{{ buttonText }}</el-button>
      </div>
      <div id="editor">
        <mavon-editor @save="save" @change="change" :value="articleInitValue"></mavon-editor>
      </div>
    </el-col>
  </div>
</template>
<script>
  import { mavonEditor } from 'mavon-editor'
  import 'mavon-editor/dist/css/index.css'
  import {saveArticleAPI, getArticleCategoryAPI, queryArticleAPI} from '@/api/article'
  export default {
    components: {
      mavonEditor
    },
    data () {
      return {
        id: '',
        buttonText: '发表文章',
        articleInitValue: '',
        submitLoading: false,
        formItem: {
          title: '',
          createTime: Date.now(),
          abstract: '',
          content: '',
          rawContent: '',
          draft: '',
          category: ''
        },
        categoryOptions: []
      }
    },
    methods: {
      save (value, render) {
//        console.log('value', value)
//        console.log('render', render)
      },
      change (value, render) {
        this.formItem.rawContent = value
        this.formItem.content = render
//        console.log('content', this.formItem.content)
      },
      updateDate () {
        this.formItem.createTime = new Date()
      },
      updateCategoryList () {
        getArticleCategoryAPI()
          .then((res) => {
            this.categoryOptions = res.data.result
          })
          .catch(() => {
          })
      },
      submit () {
        if (!this.formItem.title) {
          this.$message('文章标题不能为空!')
          return
        } else if (!this.formItem.createTime) {
          this.$message('发布日期不能为空!')
          return
        } else if (!this.formItem.category) {
          this.$message('文章类别不能为空!')
          return
        } else if (!this.formItem.content) {
          this.$message('文章内容不能为空!')
          return
        }
        // 禁用提交按钮
        this.submitLoading = true
        if (!this.formItem.abstract) {
          let reg = /<[^>]+>/g
          let abstract = this.formItem.content.replace(reg, '').replace(/(\s)/g, '').replace(/[\\'"/\b\f\n\r\t]/g, '')
          this.formItem.abstract = abstract.substr(0, 200) + '...'
        }
        // 若id存在,说明是修改文章
        if (this.id) {
          Object.assign(this.formItem, {id: this.id})
          console.log('this.form', this.formItem)
        }
        saveArticleAPI(this.formItem)
          .then((res) => {
            this.$message({
              message: this.id ? '文章修改成功!' : '文章发表成功!',
              type: 'success'
            })
            this.submitLoading = false
            this.$router.push({name: 'article-manage'})
          })
          // error统一在fetch中处理
          .catch(() => {
            this.submitLoading = false
          })
      }
    },
//    mounted () {
//      this.updateCategoryList()
//      this.updateDate()
//    },
    beforeRouteEnter (to, from, next) {
      console.log('beforeEnter')
      next((vue) => {
        console.log('beforeEnter next')
        // TODO 数据获取期间显示进度条
        vue.updateCategoryList()
        vue.updateDate()
        let id = vue.$route.query.id
        if (id) {
          vue.id = id
          vue.buttonText = '修改文章'
          queryArticleAPI({id: id})
            .then((res) => {
              vue.formItem = res.data.result
              vue.articleInitValue = vue.formItem.rawContent
            })
            .catch(() => {
            })
        }
      })
    },
    beforeRouteLeave (to, from, next) {
      // TODO 离开前保存草稿 自动保存草稿
//      console.log('to', to)
//      console.log('from', from)
//      console.log('content', this.formItem.rawContent)
      next()
    }
  }
</script>
<style scoped>
 #editor {
   margin-top: 10px;
 }
 .editor-wrap {
   overflow: hidden;
 }
  .markdown-body {
    height: 400px;
  }
  .editor-header {
  }
  .article-title {
    width: 250px;
    display: inline-block;
  }
  .commit {
    float: right;
  }
  .abstract,.article-category,.date {
    display: inline-block;
  }
  .abstract {
    width: 300px;
  }
</style>
